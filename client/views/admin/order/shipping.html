<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <!-- Meta, title, CSS, favicons, etc. -->
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Orders Shipping</title>
  <link rel="icon" href="{{app.url}}static/public/images/logo_morningowl_2-300x76.png" sizes="32x32" />
  <link rel="icon" href="{{app.url}}static/public/images/logo_morningowl_2-300x76.png" sizes="192x192" />
  <!-- Bootstrap -->
  <link href="{{app.url}}vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="{{app.url}}vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
  <!-- NProgress -->
  <link href="{{app.url}}vendors/nprogress/nprogress.css" rel="stylesheet">
  <!-- iCheck -->
  <link href="{{app.url}}vendors/iCheck/skins/flat/green.css" rel="stylesheet">
  <!-- Datatables -->
  <link href="{{app.url}}vendors/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet">
  <link href="{{app.url}}vendors/datatables.net-buttons-bs/css/buttons.bootstrap.min.css" rel="stylesheet">
  <link href="{{app.url}}vendors/datatables.net-fixedheader-bs/css/fixedHeader.bootstrap.min.css"
    rel="stylesheet">
  <link href="{{app.url}}vendors/datatables.net-responsive-bs/css/responsive.bootstrap.min.css"
    rel="stylesheet">
  <link href="{{app.url}}vendors/datatables.net-scroller-bs/css/scroller.bootstrap.min.css" rel="stylesheet">

  <!-- Custom Theme Style -->
  <link href="{{app.url}}build/css/custom.min.css" rel="stylesheet">
  <style>
    .input {
      width: 100%;
    }
    .item-row{
      padding: 18px 0px;
      border-bottom: 1px dashed #c5bfbf;
    }
  </style>
</head>

<body class="nav-md">
  <div class="container body">
    <div class="main_container">
      <!-- top navigation -->
       {{ include 'admin/global/header' }}
      
     
    {{ include 'admin/global/sidebar' }}
      <!-- page content -->
      <div class="right_col" role="main">
        <div class="">


          <div class="clearfix"></div>


          <div class="row">
			<div class="col-md-12 col-sm-12 col-xs-12">
              <div class="x_panel">
                <div class="x_title">
                  <h2>Add Shipping Detail</h2>
                  <ul class="nav navbar-right panel_toolbox">
                    <li><a class="collapse-link" id="send_sms_mailbox"><i class="fa fa-chevron-up"></i></a>
                    </li>
                    <li class="dropdown">
                      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i
                          class="fa fa-wrench"></i></a>
                      <ul class="dropdown-menu" role="menu">
                        <li><a href="#">Settings 1</a>
                        </li>
                        <li><a href="#">Settings 2</a>
                        </li>
                      </ul>
                    </li>
                    <li><a class="close-link"><i class="fa fa-close"></i></a>
                    </li>
                  </ul>
                  <div class="clearfix"></div>
                </div>
                <div class="x_content" >

                    <div class="row">
                     
                      
                        <div class="col-md-8">
                      	 <form method="POST" id="ShippingForm" action="{{app.url}}admin/order-shipping" onsubmit="return submitShipping(this)">
                 		       <label>Select Order: </label> 
                           <input type="hidden" name="shipping[userId]" value="">
                           
                         <input class="form-control order-list" list="orders"  onchange="getOrderItems(this)" name="shipping[orderId]" data-index="0" data-id="{{order.id}}"  placeholder="Enter Order Number" required>
                             <datalist id="orders">
                           {{#each orders}}
                          <option value="{{id}}">Order Number</option>
                          {{/each}}
                        </datalist>  

                           <div class="order-items"></div>
		                        <br>
		                        <label> Dispatch Through:</label>
		                        <textarea rows="5" type="text" class="form-control" name="shipping[dispatchFrom]" value="" ></textarea>
		                        <br>
                            <div class="row">
                              <div class="col-md-6">
		                        <label> Vehicle Number / Tracking Number</label>
		                        <input type="text" class="form-control" name="shipping[vehicleNumber]"  required="">
		                        </div>
                            <div class="col-md-6">
                            <label>Driver Contact Details:</label>
                            <input type="text" class="form-control" name="shipping[shipperContact]"  required="">
                            <br>
                            </div>
                          </div>
                            <label>Terms of delivery:</label>
		                        <textarea type="text" readonly class="form-control" rows="5" name="shipping[detail]"  required placeholder="Terms of delivery" maxlength="560">Terms of delivery replace here</textarea>
                            <br>

                            <div class="shippingOrderStatus hide"></div> 

		                         <br>

		                          <button type="submit" class="btn btn-md pull-right btn-info ship-create">&nbsp; CREATE  &nbsp;</button>
                          </form>
                      </div>
                      
                      <div class="col-md-4">
                        <label>Order Info</label>
                        <div class="order-info">

                        </div>


                      </div>

                      
                      
                    </div>
                

            


                </div>
              </div>

            </div>
          </div>







         

        


        </div>
        <!-- /page content -->

        <!-- footer content -->
        {{ include 'admin/global/footer' }}


        <!-- /footer content -->
      </div>
    </div>

    <!-- jQuery -->
    <script src="{{app.url}}vendors/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="{{app.url}}vendors/bootstrap/dist/js/bootstrap.min.js"></script>
    <!-- FastClick -->
    <script src="{{app.url}}vendors/fastclick/lib/fastclick.js"></script>
    <!-- NProgress -->
    <script src="{{app.url}}vendors/nprogress/nprogress.js"></script>
    <!-- iCheck -->
    <script src="{{app.url}}vendors/iCheck/icheck.min.js"></script>
    <!-- Datatables -->
    <script src="{{app.url}}vendors/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="{{app.url}}vendors/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
    <script src="{{app.url}}vendors/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="{{app.url}}vendors/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
    <script src="{{app.url}}vendors/datatables.net-buttons/js/buttons.flash.min.js"></script>
    <script src="{{app.url}}vendors/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="{{app.url}}vendors/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="{{app.url}}vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js"></script>
    <script src="{{app.url}}vendors/datatables.net-keytable/js/dataTables.keyTable.min.js"></script>
    <script src="{{app.url}}vendors/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
    <script src="{{app.url}}vendors/datatables.net-responsive-bs/js/responsive.bootstrap.js"></script>
    <script src="{{app.url}}vendors/datatables.net-scroller/js/dataTables.scroller.min.js"></script>
    <script src="{{app.url}}vendors/jszip/dist/jszip.min.js"></script>
    <script src="{{app.url}}vendors/pdfmake/build/pdfmake.min.js"></script>
    <script src="{{app.url}}vendors/pdfmake/build/vfs_fonts.js"></script>

    <!-- Custom Theme Scripts -->
    <script src="{{app.url}}build/js/custom.min.js"></script>
    <script type="text/javascript">
      var totalRows = 0;
     function  getOrderItems(t){
       var orderId = jQuery(t).val();
       var html = '';
       var orderInfo ='';
       app.post('/api/get-order-items',{orderId},res=>{
            if(!res.err){
              totalRows = res.data.length;
              jQuery('[name="shipping[userId]"]').val(res.order.userId);
              for (i in res.data) { 
                var item = res.data[i];
              html += '<div class="item-row del-item-'+i+'"><div class="row"><div class="col-md-6">\
                        '+item.name+', <br> '+item.sortDesc+'\
                             </div>\
                             <div class="col-md-3">  Pending Qty:'+item.pendingQty+'<br>Shipped:'+(item.qty-item.pendingQty)+'</div>\
                              <div class="col-md-2">Quantity:\
                             <input type="hidden" name="ship[itemCategory][]" value="'+item.category+'">\
                             <input type="hidden" name="ship[itemName][]" value="'+item.name+'">\
                             <input type="hidden" name="ship[itemSortDesc][]" value="'+item.sortDesc+'">\
                             <input type="hidden" name="ship[itemQty][]" value="'+item.pendingQty+'">\
                             <input type="hidden" name="ship[hsnSac][]" value="'+item.hsnSac+'">\
                            <input type="hidden" name="ship[orderItemId][]" value="'+item.id+'"><input type="hidden" name="ship[productId][]" value="'+item.productId+'"><input type="number" min="0"\
                              class="form-control ship-qty" onchange="setShipStatus(this)" name="ship[qty][]" max="'+item.pendingQty+'" value="0" >\
                            <input type="hidden" name="ship[tax][]" value="'+item.tax+'" >\
                            <input type="hidden" name="ship[rate][]" value="'+item.price+'" >\
                            </div><div class="col-md-1"><br><a class="btn btn-xs btn-danger" index="'+i+'" onclick="removeItem(this)">&times</a></div>\
                      </div></div>';
                    }



                    jQuery('.order-items').html(html);

                    orderInfo += '<label>Total Amount:</label> '+res.order.total+'<hr style="margin:5px;">';
                    var address = JSON.parse(res.order.orderAddress);
                    orderInfo += '<label>Ship To:</label> '+address.ship_first_name+' ' +address.ship_last_name+'<br>';
                          
                         orderInfo += address.ship_address +'<br> '+address.ship_address_more+' <br>'+address.ship_state_country +' '+address.ship_zip +'<br>'+
                          'Email:' +address.ship_email +', Contact: '+address.ship_phone+'<hr style="margin:5px;">';

                          var shippingOrderStatus = '<label><input class="partialCheck" readonly type="radio"  name="orderStatus" value="Partially Shipped" onclick="partialCheck()" required checked> Partially Shipped</label>'+
                          '<br><label><input  type="radio" readonly class="shippedCheck" onclick="confirmCheck(this)" name="orderStatus" value="Shipped" required> Shipped</label><br><span class="ship-msg"></span>';

                    jQuery('.order-info').html(orderInfo);
                    jQuery('.shippingOrderStatus').html(shippingOrderStatus);
            }else{
                app.showToast("Item Not found!");
            }
            
        })

       
     }

     var order = '';
     /*
    $('.order-list').hover(function() {
      if($(this).val().length)
        order = $(this).val(); 
    $(this).val('');
  },function(){
    $(this).val(order);
  });*/
  

function removeItem(t){
  var index = $(t).attr('index');
  
  jQuery('.del-item-'+index).remove();
  totalRows--;
  if(!totalRows){
    jQuery('#ShippingForm').trigger('reset');
    jQuery('.order-info').text('');
  }
}



function submitShipping(t){
  var data = jQuery(t).serialize();
  var qtyCk = 0;
  var status = jQuery('[name="orderStatus"]').is(':checked');
  if(!status){
    app.showToast("Please select shipping status.");
    return !1;
  }else{
  	jQuery('.ship-create').attr('disabled',true);
  	jQuery('.ship-qty').each(function(){
  		if(parseInt($(this).val())>0)
  			qtyCk++;
  	});

  		setTimeout(()=>{
  			if(qtyCk)
  				sendDataToShip(t,data);
  			else{
  				 app.showToast("Please add Quantity to ship.",1);
         		jQuery('.ship-create').attr('disabled',false);
  			}

  		},500);
   
  }
  return !1;
}


function sendDataToShip(t,data){
	 app.post('/api/create-shipping-items',data,res=>{
      if(!res.err){
        jQuery(t).trigger('reset');
        jQuery('.order-info').text('');
         jQuery('.order-items').html('');
         jQuery('.ship-create').attr('disabled',false);
        location.href = '/admin/invoice/'+res.id;
      }
      app.showToast(res.msg,res.err);
    });
}


function confirmCheck(t) {
    jQuery('.ship-msg').html('<b class="text-danger">This status will mark as a complete order.');
}

function partialCheck(){
  jQuery('.ship-msg').text('');
}


function setShipStatus(t){
 
var shipFlag = 0;

$('.ship-qty').each(function(){
       var itemQty = $(this).attr('max');
       var shipQty = $(this).val();
       if(itemQty != shipQty)
          shipFlag++;
        
});

if(!shipFlag)
    $('.shippedCheck').click();
else
  $('.partialCheck').click();
 

}


</script>


    <div id="OrderUpdateModal" class="modal fade-scale" role="dialog">
      <div class="modal-dialog custom-size-dialog" style="width:85%">

        <!-- Modal content-->
        <div class="modal-content">
          <div class="modal-header">
            <div class="modal-title">
              <button type="button" class="close" data-dismiss="modal">&times;</button>

              <h5>Update Order</h5>

            </div>



          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-3">
                <select class="form-control" name="order_status" required>
                  <option value="" selected disabled>SELECT ORDER STATUS</option>
                  <option value="Ordered">Ordered</option>
                  <option value="Ordered">Ordered</option>
                  <option value="Shipped">Shipped</option>
                  <option value="Delivered">Delivered</option>
                </select>
              </div>
            </div>


          </div>

          <div class="modal-footer">
            <button class="btn btn-sm btn-success">Save</button>
          </div>
        </div>
      </div>
    </div>


</body>

</html>